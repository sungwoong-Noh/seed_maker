# Seed Maker 개발 로그

## 프로젝트 개요
지출 기록 → 절약(씨앗돈) → 배당주 투자 시뮬레이션까지 연결하는 게이미피케이션 기반 예산 관리 앱

---

## 완료된 작업

### Phase 1: 기획 및 설계 ✅

#### 문서화
- `docs/user-scenarios.md`: 7가지 사용자 시나리오 정의
- `docs/screens.md`: 화면 목록 및 와이어프레임
- `docs/db-schema.md`: 데이터베이스 스키마 설계
- `docs/api-spec.md`: REST API 명세

#### 핵심 개념
- **씨앗돈**: 예산 대비 절약액 (예산 - 실지출)
- **씨앗 수확**: 1만원당 씨앗 1알
- **배당 시뮬레이션**: 씨앗돈으로 배당주 투자 시 목표 달성 기간 계산

---

### Phase 2: Next.js 웹 앱 구현 ✅

#### 프로젝트 설정
- **프레임워크**: Next.js 16.1.6 (App Router)
- **인증**: Supabase Auth
- **데이터베이스**: Supabase (PostgreSQL)
- **스타일링**: Tailwind CSS 4
- **상태 관리**: Zustand, TanStack Query

#### 데이터베이스 스키마
5개 테이블 + RLS 정책:
- `categories`: 지출 카테고리 (식비, 교통, 공과금, 쇼핑, 의료, 기타)
- `budgets`: 카테고리별 월 예산
- `expenses`: 지출 기록
- `dividend_stocks`: 배당주 보유 현황
- `dividend_goals`: 목표 월 배당금

마이그레이션 파일:
- `supabase/migrations/20250213000000_initial_schema.sql`
- `supabase/migrations/20250213000001_reset_schema.sql` (재생성용)

#### 구현된 기능

##### 1. 인증 (Authentication)
- **로그인**: `/login`
  - 이메일/비밀번호 로그인
  - Supabase Auth 연동
  - 에러 처리
- **회원가입**: `/signup`
  - 이메일/비밀번호 입력
  - 비밀번호 확인 (6자 이상)
  - 가입 후 자동 로그인
- **미들웨어**: 인증되지 않은 사용자 리다이렉트

##### 2. 대시보드 (`/`)
**컴포넌트**: `src/components/dashboard/Dashboard.tsx`

표시 정보:
- 이번 달 씨앗돈 (절약액)
- 씨앗 수확 개수 (만원당 1알)
- 예산 대비 실지출 진행률
- 목표 월 배당금 진행률
- 목표 달성까지 예상 기간
- 연속 기록 스트릭
- 최근 지출 5건

기능:
- 지출 추가 모달
- 카테고리별 절약 현황
- 로그아웃

##### 3. 지출 관리 (`/expenses`)
**컴포넌트**: `src/components/expenses/ExpenseList.tsx`

기능:
- 월별 지출 목록 조회
- 지출 추가 (금액, 카테고리, 일자, 메모)
- 지출 삭제
- 카테고리별 필터링

##### 4. 예산 설정 (`/budget`)
**컴포넌트**: `src/components/budget/BudgetForm.tsx`

기능:
- 카테고리별 월 예산 입력
- 기존 예산 조회 및 수정
- 예산 저장 (upsert)

**최근 수정**: useEffect 무한 루프 버그 수정 (의존성 배열 최적화)

##### 5. 배당 포트폴리오 (구현 중)
**컴포넌트**:
- `src/components/portfolio/PortfolioList.tsx`
- `src/components/portfolio/AddStockModal.tsx`

기능:
- 보유 배당주 목록
- 종목 추가 (티커, 종목명, 수량, 주당 배당금, 주가)
- 현재 월 배당금 계산

##### 6. 목표 설정 (구현 중)
기능:
- 목표 월 배당금 설정
- 추가 월 납입액 설정
- 달성 예상 기간 시뮬레이션

#### API Routes
- `/api/dashboard`: 대시보드 집계 데이터
  - 씨앗돈, 예산/실지출, 배당 진행률, 스트릭 계산

#### 유틸리티
- `src/lib/supabase/client.ts`: 클라이언트 사이드 Supabase 클라이언트
- `src/lib/supabase/server.ts`: 서버 컴포넌트용 Supabase 클라이언트
- `src/lib/simulation.ts`: 배당 목표 달성 시뮬레이션
- `src/lib/format.ts`: 숫자 포맷팅 (원화)
- `src/hooks/useBudgets.ts`: 예산 관리 훅
- `src/hooks/useExpenses.ts`: 지출 관리 훅

---

## 현재 상태

### 작동 중인 기능
- ✅ 로그인/회원가입
- ✅ 대시보드 (씨앗돈, 진행률, 스트릭)
- ✅ 지출 추가/조회/삭제
- ✅ 예산 설정
- ✅ 배당 포트폴리오 (UI 구현됨)

### 미완성 기능
- ⏳ `/portfolio` 페이지 (컴포넌트는 있지만 라우트 미연결)
- ⏳ `/goal` 페이지 (목표 설정 및 시뮬레이션)
- ⏳ 대시보드 카테고리별 상세 표시

---

## 환경 설정

### 필수 환경 변수 (`web/.env.local`)
```bash
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-or-publishable-key
```

**주의**: 
- Supabase는 새로운 Publishable Key 형식(`sb_publishable_xxx`)과 기존 anon key 형식(`eyJ...`) 모두 지원
- 환경 변수명은 `NEXT_PUBLIC_SUPABASE_ANON_KEY`로 통일 (코드에서 이 이름으로 읽음)

### 개발 서버 실행
```bash
cd web
npm install
npm run dev
```

**포트**: 3000 (사용 중이면 3001, 3002 등으로 자동 변경)

---

## 해결된 이슈

### 1. 환경 변수 로딩 문제
**증상**: Server Components에서 `process.env.NEXT_PUBLIC_SUPABASE_*`가 undefined

**시도한 방법**:
- `next.config.ts`의 `env` 블록
- `@next/env.loadEnvConfig`
- `dotenv` 패키지
- 수동 `.env.local` 파싱
- 하드코딩

**최종 해결**: 
- `next.config.js`의 `env` 블록 제거
- Next.js의 기본 `.env.local` 자동 로딩 사용
- 올바른 Supabase 키 형식 사용 (Publishable Key)

### 2. BudgetForm 무한 루프
**증상**: `useEffect`에서 "Maximum update depth exceeded" 에러

**원인**: `categories` 객체가 매 렌더링마다 새로 생성되어 의존성 배열이 계속 변경됨

**해결**: 의존성을 `categories?.length`로 변경하여 개수 변경 시에만 실행

### 3. Cursor IDE 터미널 네트워크 에러
**증상**: `uv_interface_addresses` 시스템 에러

**원인**: Cursor IDE 샌드박스 환경의 제약

**해결**: 외부 터미널(iTerm, Terminal.app)에서 `npm run dev` 실행

---

## 다음 단계 (TODO)

### 즉시 필요한 작업
1. **Supabase 테이블 생성**: SQL Editor에서 마이그레이션 실행
2. **회원가입**: `http://localhost:3001/signup`에서 계정 생성
3. **테스트**: 로그인 → 대시보드 → 지출 추가 → 예산 설정 흐름 확인

### 미완성 기능 구현
1. `/portfolio` 페이지 라우트 연결
2. `/goal` 페이지 구현 (목표 설정 + 시뮬레이션)
3. 대시보드 카테고리별 상세 표시 개선
4. 설정 페이지 (`/settings`)

### Phase 3: 모바일 앱
- Expo React Native 앱
- 웹과 공통 로직 공유 (API 호출, 타입 정의)

---

## 기술 스택

### Frontend
- **Next.js 16.1.6**: React 프레임워크 (App Router)
- **React 19.2.3**: UI 라이브러리
- **TypeScript 5**: 타입 안전성
- **Tailwind CSS 4**: 스타일링

### Backend & Database
- **Supabase**: BaaS (Backend as a Service)
  - PostgreSQL 데이터베이스
  - Auth (이메일/비밀번호)
  - Row Level Security (RLS)

### 상태 관리
- **TanStack Query 5**: 서버 상태 관리
- **Zustand 5**: 클라이언트 상태 관리

### 개발 도구
- **ESLint 9**: 코드 린팅
- **Turbopack**: Next.js 번들러

---

## 프로젝트 구조

```
seed_maker/
├── docs/                           # 기획 문서
│   ├── user-scenarios.md          # 사용자 시나리오
│   ├── screens.md                 # 화면 목록
│   ├── db-schema.md               # DB 스키마
│   ├── api-spec.md                # API 명세
│   └── development-log.md         # 이 파일
├── supabase/
│   └── migrations/                # DB 마이그레이션
│       ├── 20250213000000_initial_schema.sql
│       └── 20250213000001_reset_schema.sql
├── web/                           # Next.js 앱
│   ├── src/
│   │   ├── app/
│   │   │   ├── (auth)/           # 인증 페이지
│   │   │   │   ├── login/
│   │   │   │   └── signup/
│   │   │   ├── (main)/           # 메인 페이지
│   │   │   │   ├── layout.tsx
│   │   │   │   ├── page.tsx      # 대시보드
│   │   │   │   ├── budget/
│   │   │   │   └── expenses/
│   │   │   ├── api/              # API Routes
│   │   │   │   └── dashboard/
│   │   │   └── layout.tsx
│   │   ├── components/
│   │   │   ├── dashboard/        # 대시보드 컴포넌트
│   │   │   ├── budget/           # 예산 컴포넌트
│   │   │   ├── expenses/         # 지출 컴포넌트
│   │   │   ├── portfolio/        # 배당 포트폴리오
│   │   │   └── providers/        # React Query Provider
│   │   ├── hooks/                # Custom Hooks
│   │   ├── lib/                  # 유틸리티
│   │   │   ├── supabase/         # Supabase 클라이언트
│   │   │   ├── simulation.ts     # 배당 시뮬레이션
│   │   │   └── format.ts         # 포맷팅
│   │   ├── types/                # TypeScript 타입
│   │   └── middleware.ts         # 인증 미들웨어
│   ├── .env.local                # 환경 변수 (Git 제외)
│   ├── next.config.js
│   ├── package.json
│   └── tsconfig.json
├── .cursorrules                   # AI 어시스턴트 규칙
└── README.md
```

---

## 핵심 비즈니스 로직

### 씨앗돈 계산
```typescript
// 카테고리별 절약액 계산
const saved = Math.max(0, budget - actual);

// 전체 씨앗돈
const seedMoney = categories.reduce((sum, cat) => sum + saved(cat), 0);

// 씨앗 개수
const seedCount = Math.floor(seedMoney / 10000);
```

### 배당 시뮬레이션
```typescript
// 현재 월 배당금
const currentMonthlyDividend = stocks.reduce((sum, s) => 
  sum + (s.quantity * s.dividend_per_share / 12), 0
);

// 목표 달성까지 기간 (월)
// 매월 seedMoney + extraDeposit 투자
// 평균 배당 수익률 적용
```

### 스트릭 계산
- 연속으로 지출을 기록한 일수
- 오늘부터 역순으로 카운트
- 하루라도 빠지면 리셋

---

## 주요 컴포넌트 설명

### Dashboard
**경로**: `src/components/dashboard/Dashboard.tsx`

**역할**: 메인 화면, 모든 핵심 지표 표시

**데이터 소스**: `/api/dashboard` API Route

**주요 기능**:
- 씨앗돈 카드 (절약액, 씨앗 개수)
- 예산 vs 실지출 진행률
- 목표 배당 진행률
- 스트릭 표시
- 최근 지출 목록
- 지출 추가 모달

### BudgetForm
**경로**: `src/components/budget/BudgetForm.tsx`

**역할**: 카테고리별 월 예산 입력/수정

**데이터 흐름**:
1. `useBudgets` 훅으로 기존 예산 조회
2. `categories` 테이블에서 카테고리 목록 조회
3. 사용자 입력 → `upsertBudgets` → Supabase 저장

**버그 수정**: useEffect 무한 루프 (의존성 배열 최적화)

### ExpenseList
**경로**: `src/components/expenses/ExpenseList.tsx`

**역할**: 지출 목록 조회 및 관리

**기능**:
- 월별 지출 조회
- 지출 추가 모달
- 지출 삭제
- 카테고리별 그룹핑

---

## API 설계

### GET /api/dashboard
**Query**: `yearMonth` (YYYY-MM)

**Response**:
```json
{
  "seedMoney": 150000,
  "seedCount": 15,
  "budgetTotal": 500000,
  "expenseTotal": 350000,
  "byCategory": [
    {
      "categoryId": "uuid",
      "categoryName": "식비",
      "budget": 300000,
      "actual": 250000,
      "saved": 50000
    }
  ],
  "currentMonthlyDividend": 800000,
  "targetMonthlyDividend": 1000000,
  "progressPercent": 80,
  "monthsToGoal": 8,
  "streakDays": 7
}
```

**계산 로직**:
- 예산/지출 집계
- 카테고리별 절약액
- 배당주 포트폴리오에서 현재 월 배당금
- 목표 달성 시뮬레이션
- 스트릭 계산 (연속 기록 일수)

---

## 알려진 이슈 및 해결 방법

### 1. 환경 변수 로딩 실패
**증상**: "Supabase URL/Key가 없습니다" 에러

**해결**:
1. `.env.local` 파일에 올바른 Supabase 키 입력
2. Supabase Dashboard → Settings → API에서 키 복사
3. `NEXT_PUBLIC_SUPABASE_ANON_KEY`에 Publishable Key 또는 anon key 입력
4. `rm -rf .next && npm run dev`로 재시작

### 2. BudgetForm 무한 루프
**증상**: "Maximum update depth exceeded"

**해결**: `useEffect` 의존성을 `categories?.length`로 변경

### 3. Cursor IDE 터미널 에러
**증상**: `uv_interface_addresses` 시스템 에러

**해결**: 외부 터미널에서 `npm run dev` 실행

### 4. 로그인 실패 ("Invalid login credentials")
**원인**: 
- 계정이 없음
- 이메일 미인증 (Supabase 기본 설정)

**해결**:
- `/signup`에서 회원가입
- 또는 Supabase Dashboard → Authentication에서 사용자 수동 생성 (Auto Confirm 체크)

---

## 개발 가이드

### 로컬 개발 환경 설정

1. **Supabase 프로젝트 생성**
   - https://supabase.com 가입
   - 새 프로젝트 생성
   - Region: Northeast Asia (Seoul)

2. **데이터베이스 초기화**
   - SQL Editor에서 `supabase/migrations/20250213000001_reset_schema.sql` 실행

3. **환경 변수 설정**
   - `web/.env.local` 파일 생성
   - Supabase URL 및 키 입력

4. **의존성 설치 및 실행**
   ```bash
   cd web
   npm install
   npm run dev
   ```

5. **첫 사용자 생성**
   - `http://localhost:3000/signup` 접속
   - 이메일/비밀번호로 가입

### 디버깅 팁

- **환경 변수 확인**: `server.ts`에 console.log 추가됨
- **브라우저 콘솔**: F12 → Console 탭에서 클라이언트 에러 확인
- **Supabase 로그**: Dashboard → Logs에서 DB 쿼리 에러 확인
- **RLS 정책**: 데이터 접근 안되면 RLS 정책 확인

---

## Git 관리

### 커밋하지 말아야 할 파일
- `node_modules/`
- `.next/`
- `.env*` (특히 `.env.local`)
- `*.tsbuildinfo`

### 커밋해야 할 파일
- `src/` (소스 코드)
- `package.json`, `package-lock.json`
- `next.config.js`, `tsconfig.json`
- `docs/`, `supabase/migrations/`
- `README.md`

### .env.example 생성 권장
```bash
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

---

## 성능 최적화 (향후)

- [ ] React Query 캐싱 전략 개선
- [ ] 이미지 최적화 (Next.js Image)
- [ ] 코드 스플리팅
- [ ] 대시보드 데이터 prefetching
- [ ] Supabase Realtime 구독 (실시간 업데이트)

---

## 배포 (향후)

### Vercel 배포
1. GitHub에 푸시
2. Vercel 연결
3. 환경 변수 설정
4. 자동 배포

### 환경 변수 (Production)
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`

---

## 참고 문서

- [Next.js 공식 문서](https://nextjs.org/docs)
- [Supabase Next.js 가이드](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [TanStack Query 문서](https://tanstack.com/query/latest)
- [Tailwind CSS 문서](https://tailwindcss.com/docs)

---

**최종 업데이트**: 2026-02-13
**현재 버전**: MVP (Minimum Viable Product)
**개발 상태**: 핵심 기능 구현 완료, 추가 기능 개발 중
